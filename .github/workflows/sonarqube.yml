name: CI Python & SonarQube Analysis

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ›Žï¸ Checkout code
        uses: actions/checkout@v4
        with:
          # Importante: se requiere el historial completo para el anÃ¡lisis de SonarQube
          fetch-depth: 0 

      - name: ðŸ› ï¸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          # Usar la versiÃ³n recomendada por tus requerimientos
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Instala todas las dependencias del proyecto, incluyendo pytest y pytest-cov
          pip install -r requirements.txt 

      # Tarea I: CompilaciÃ³n (en Python es la instalaciÃ³n) y EjecuciÃ³n de Pruebas
      - name: ðŸ§ª Run Tests & Generate Reports
        run: |
          # 1. Ejecutar pruebas (pytest) y generar dos reportes en formato XML:
          #    - coverage.xml (para la Cobertura de CÃ³digo)
          #    - junit.xml (para los Resultados de las Pruebas)
          # NOTA: AsegÃºrate de tener el plugin necesario, como pytest-junitxml, si pytest-cov no lo genera automÃ¡ticamente.
          pytest --cov-report=xml --cov=. --junitxml=junit.xml 
          
          # 2. Ejecutar el anÃ¡lisis de estilo de cÃ³digo (Linting)
          flake8 . --output-file=flake8_report.txt --exit-zero

          # ... (Pasos anteriores)

      # Tarea II: AnÃ¡lisis EstÃ¡tico con SonarQube
      - name: ðŸ” SonarQube Analysis
        uses: SonarSource/sonarcloud-github-action@v2.2
        # Las credenciales se pasan como variables de entorno (env)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          # ParÃ¡metros para configurar el escÃ¡ner de Python
          args: >
            -Dsonar.projectKey=Yaelgpt_pruebaaaaaaaaaaaaa
            -Dsonar.organization=tu_organizacion_en_sonarcloud
            -Dsonar.sources=.
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.python.xunit.reportPaths=junit.xml
            -Dsonar.python.flake8.reportPaths=flake8_report.txt

name: CI Python & SonarQube Analysis

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: üõéÔ∏è Checkout code
        uses: actions/checkout@v4
        with:
          # Importante: se requiere el historial completo para el an√°lisis de SonarQube
          fetch-depth: 0 

      - name: üõ†Ô∏è Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          # Usar la versi√≥n recomendada por tus requerimientos
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Instala todas las dependencias del proyecto, incluyendo pytest y pytest-cov
          pip install -r requirements.txt 

      # Tarea I: Compilaci√≥n (en Python es la instalaci√≥n) y Ejecuci√≥n de Pruebas
      - name: üß™ Run Tests & Generate Reports
        run: |
          # 1. Ejecutar pruebas (pytest) y generar dos reportes en formato XML:
          #    - coverage.xml (para la Cobertura de C√≥digo)
          #    - junit.xml (para los Resultados de las Pruebas)
          # NOTA: Aseg√∫rate de tener el plugin necesario, como pytest-junitxml, si pytest-cov no lo genera autom√°ticamente.
          pytest --cov-report=xml --cov=. --junitxml=junit.xml 
          
          # 2. Ejecutar el an√°lisis de estilo de c√≥digo (Linting)
          flake8 . --output-file=flake8_report.txt --exit-zero

          # ... (Pasos anteriores)

      # Tarea II: An√°lisis Est√°tico con SonarQube
      - name: üîç SonarQube Analysis
        uses: SonarSource/sonarcloud-github-action@v2.2
        # Las credenciales se pasan como variables de entorno (env)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          # Par√°metros para configurar el esc√°ner de Python
          args: >
            -Dsonar.projectKey=Yaelgpt_pruebaaaaaaaaaaaaa
            -Dsonar.organization=Yaelgpt # Solo si usas SonarCloud
            -Dsonar.sources=.
            # Le indicamos a SonarQube d√≥nde encontrar el informe de Cobertura
            -Dsonar.python.coverage.reportPaths=coverage.xml
            # Le indicamos d√≥nde encontrar los resultados de las Pruebas Unitarias
            -Dsonar.python.xunit.reportPaths=junit.xml
            # Indicamos d√≥nde est√°n los informes de Flake8
            -Dsonar.python.flake8.reportPaths=flake8_report.txt
